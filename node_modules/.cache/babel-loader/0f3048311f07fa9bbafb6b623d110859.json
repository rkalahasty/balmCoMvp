{"ast":null,"code":"\"use strict\";\n\nconst idlUtils = require(\"../../living/generated/utils\");\n\nconst {\n  fireAnEvent\n} = require(\"../../living/helpers/events\");\n\nmodule.exports = class PerDocumentResourceLoader {\n  constructor(document) {\n    this._document = document;\n    this._defaultEncoding = document._encoding;\n    this._resourceLoader = document._defaultView ? document._defaultView._resourceLoader : null;\n    this._requestManager = document._requestManager;\n    this._queue = document._queue;\n    this._deferQueue = document._deferQueue;\n    this._asyncQueue = document._asyncQueue;\n  }\n\n  fetch(url, _ref) {\n    let {\n      element,\n      onLoad,\n      onError\n    } = _ref;\n\n    const request = this._resourceLoader.fetch(url, {\n      cookieJar: this._document._cookieJar,\n      element: idlUtils.wrapperForImpl(element),\n      referrer: this._document.URL\n    });\n\n    if (request === null) {\n      return null;\n    }\n\n    this._requestManager.add(request);\n\n    const onErrorWrapped = error => {\n      this._requestManager.remove(request);\n\n      if (onError) {\n        onError(error);\n      }\n\n      fireAnEvent(\"error\", element);\n      const err = new Error(`Could not load ${element.localName}: \"${url}\"`);\n      err.type = \"resource loading\";\n      err.detail = error;\n\n      this._document._defaultView._virtualConsole.emit(\"jsdomError\", err);\n\n      return Promise.resolve();\n    };\n\n    const onLoadWrapped = data => {\n      this._requestManager.remove(request);\n\n      this._addCookies(url, request.response ? request.response.headers : {});\n\n      try {\n        const result = onLoad ? onLoad(data) : undefined;\n        return Promise.resolve(result).then(() => {\n          fireAnEvent(\"load\", element);\n          return Promise.resolve();\n        }).catch(err => {\n          return onErrorWrapped(err);\n        });\n      } catch (err) {\n        return onErrorWrapped(err);\n      }\n    };\n\n    if (element.localName === \"script\" && element.hasAttributeNS(null, \"async\")) {\n      this._asyncQueue.push(request, onLoadWrapped, onErrorWrapped, this._queue.getLastScript());\n    } else if (element.localName === \"script\" && element.hasAttributeNS(null, \"defer\")) {\n      this._deferQueue.push(request, onLoadWrapped, onErrorWrapped, false, element);\n    } else {\n      this._queue.push(request, onLoadWrapped, onErrorWrapped, false, element);\n    }\n\n    return request;\n  }\n\n  _addCookies(url, headers) {\n    let cookies = headers[\"set-cookie\"];\n\n    if (!cookies) {\n      return;\n    }\n\n    if (!Array.isArray(cookies)) {\n      cookies = [cookies];\n    }\n\n    cookies.forEach(cookie => {\n      this._document._cookieJar.setCookieSync(cookie, url, {\n        http: true,\n        ignoreError: true\n      });\n    });\n  }\n\n};","map":{"version":3,"names":["idlUtils","require","fireAnEvent","module","exports","PerDocumentResourceLoader","constructor","document","_document","_defaultEncoding","_encoding","_resourceLoader","_defaultView","_requestManager","_queue","_deferQueue","_asyncQueue","fetch","url","element","onLoad","onError","request","cookieJar","_cookieJar","wrapperForImpl","referrer","URL","add","onErrorWrapped","error","remove","err","Error","localName","type","detail","_virtualConsole","emit","Promise","resolve","onLoadWrapped","data","_addCookies","response","headers","result","undefined","then","catch","hasAttributeNS","push","getLastScript","cookies","Array","isArray","forEach","cookie","setCookieSync","http","ignoreError"],"sources":["C:/Users/17033/balmco/node_modules/jsdom/lib/jsdom/browser/resources/per-document-resource-loader.js"],"sourcesContent":["\"use strict\";\nconst idlUtils = require(\"../../living/generated/utils\");\nconst { fireAnEvent } = require(\"../../living/helpers/events\");\n\nmodule.exports = class PerDocumentResourceLoader {\n  constructor(document) {\n    this._document = document;\n    this._defaultEncoding = document._encoding;\n    this._resourceLoader = document._defaultView ? document._defaultView._resourceLoader : null;\n    this._requestManager = document._requestManager;\n    this._queue = document._queue;\n    this._deferQueue = document._deferQueue;\n    this._asyncQueue = document._asyncQueue;\n  }\n\n  fetch(url, { element, onLoad, onError }) {\n    const request = this._resourceLoader.fetch(url, {\n      cookieJar: this._document._cookieJar,\n      element: idlUtils.wrapperForImpl(element),\n      referrer: this._document.URL\n    });\n\n    if (request === null) {\n      return null;\n    }\n\n    this._requestManager.add(request);\n\n    const onErrorWrapped = error => {\n      this._requestManager.remove(request);\n\n      if (onError) {\n        onError(error);\n      }\n\n      fireAnEvent(\"error\", element);\n\n      const err = new Error(`Could not load ${element.localName}: \"${url}\"`);\n      err.type = \"resource loading\";\n      err.detail = error;\n\n      this._document._defaultView._virtualConsole.emit(\"jsdomError\", err);\n\n      return Promise.resolve();\n    };\n\n    const onLoadWrapped = data => {\n      this._requestManager.remove(request);\n\n      this._addCookies(url, request.response ? request.response.headers : {});\n\n      try {\n        const result = onLoad ? onLoad(data) : undefined;\n\n        return Promise.resolve(result)\n          .then(() => {\n            fireAnEvent(\"load\", element);\n\n            return Promise.resolve();\n          })\n          .catch(err => {\n            return onErrorWrapped(err);\n          });\n      } catch (err) {\n        return onErrorWrapped(err);\n      }\n    };\n\n    if (element.localName === \"script\" && element.hasAttributeNS(null, \"async\")) {\n      this._asyncQueue.push(request, onLoadWrapped, onErrorWrapped, this._queue.getLastScript());\n    } else if (element.localName === \"script\" && element.hasAttributeNS(null, \"defer\")) {\n      this._deferQueue.push(request, onLoadWrapped, onErrorWrapped, false, element);\n    } else {\n      this._queue.push(request, onLoadWrapped, onErrorWrapped, false, element);\n    }\n\n    return request;\n  }\n\n  _addCookies(url, headers) {\n    let cookies = headers[\"set-cookie\"];\n\n    if (!cookies) {\n      return;\n    }\n\n    if (!Array.isArray(cookies)) {\n      cookies = [cookies];\n    }\n\n    cookies.forEach(cookie => {\n      this._document._cookieJar.setCookieSync(cookie, url, { http: true, ignoreError: true });\n    });\n  }\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}